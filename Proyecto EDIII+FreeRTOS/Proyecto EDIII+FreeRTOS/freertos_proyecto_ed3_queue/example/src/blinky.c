/*
 * Proyecto Electrónica Digital 3
 * Alumnos: Abanto Luis y Rota Franco
 *
 * */

#include "board.h"
#include "FreeRTOS.h"
#include "task.h"
#include "semphr.h"
#include "queue.h"
#include "arm_math.h"

#include "chip.h"
#include "arm_math.h"
#include "math_helper.h"
#include "stdio.h"
#include "string.h"

QueueHandle_t Queue_Datos;

static void prvSetupHardware(void) {
	SystemCoreClockUpdate();
	Board_Init();

	adc_init();
	uart_init();

	Board_LED_Set(0, true);
}



/*****************************************************************************
 * Private types/enumerations/variables
 ****************************************************************************/
#define  SYSTEM_BAUD_RATE 	9600
#define ADC_ID LPC_ADC0
#define ADC_CHANNEL 2
#define SAMPLING_RATE 20000


/** Definicion de MACROS **/
#define TEST_LENGTH_SAMPLES  320
#define BLOCK_SIZE            32
#define NUM_TAPS              29

static float32_t testOutput[TEST_LENGTH_SAMPLES];
static float32_t firStateF32[BLOCK_SIZE + NUM_TAPS - 1]; //buffer de estado

/* Buffer de coeficientes FIR con MATLAB fir1(28, 6/24) */
//const float32_t firCoeffs32[NUM_TAPS]={0.001569287,0.001116387,0,-0.002599688,-0.006953364,-0.011994274,-0.015023383,-0.01223138,0,0.023453016,0.056765389,0.095095161,0.131057407,0.15672628,0.166038324,0.15672628,0.131057407,0.095095161,0.056765389,0.023453016,0,-0.01223138,-0.015023383,-0.011994274,-0.006953364,-0.002599688,0,0.001116387,0.001569287};
//const float32_t firCoeffs32[NUM_TAPS]={-0.00173378491150046,-0.00132032465432659,0.00196198663394096,0.00497479091925866,-3.95687545399809e-18,-0.0114761841309428,-0.0102582438253951,0.0144657630606016,0.0324833084797670,-1.15581086390027e-17,-0.0627157374043070,-0.0562333980743783,0.0894884216205657,0.299913056104083,0.400900692365267,0.299913056104083,0.0894884216205657,-0.0562333980743783,-0.0627157374043070,-1.15581086390027e-17,0.0324833084797670,0.0144657630606016,-0.0102582438253951,-0.0114761841309428,-3.95687545399809e-18,0.00497479091925866,0.00196198663394096,-0.00132032465432659,-0.00173378491150046};
const float32_t firCoeffs32[NUM_TAPS]={0.000136783148154755,0.000748862410133318,0.00192155146061346,0.00413356191727963,0.00780888104799288,0.0132332765761775,0.0204853064215544,0.0293939489888832,0.0395312430212808,0.0502431007491932,0.0607155508925898,0.0700680267530980,0.0774608615306598,0.0822016308506011,0.0838348284635766,0.0822016308506011,0.0774608615306598,0.0700680267530980,0.0607155508925898,0.0502431007491932,0.0395312430212808,0.0293939489888832,0.0204853064215544,0.0132332765761775,0.00780888104799288,0.00413356191727963,0.00192155146061346,0.000748862410133318,0.000136783148154755};
/* -------------------------------*
 * Variables Globales del LPF FIR *
 * -------------------------------*/
uint32_t blockSize = BLOCK_SIZE;
uint32_t numBlocks = TEST_LENGTH_SAMPLES/BLOCK_SIZE;


/* -------------------------------*
 * INICIALIZACION DE PERIFERICOS  *
 * -------------------------------*/

void uart_init(void){
   Chip_UART_Init(LPC_USART2);
   Chip_UART_SetBaud(LPC_USART2, SYSTEM_BAUD_RATE);
   Chip_UART_SetupFIFOS(LPC_USART2, UART_FCR_FIFO_EN | UART_FCR_TRG_LEV0);
   Chip_UART_TXEnable(LPC_USART2); // Enable UART Transmission

   Chip_SCU_PinMux(7, 1, MD_PDN, FUNC6);              /* P7_1: UART2_TXD */
   Chip_SCU_PinMux(7, 2, MD_PLN|MD_EZI|MD_ZI, FUNC6); /* P7_2: UART2_RXD */

   //Enable UART Rx Interrupt
   Chip_UART_IntEnable(LPC_USART2,UART_IER_RBRINT);   //Receiver Buffer Register Interrupt

   //Chip_UART_IntEnable(LPC_USART2,UART_IER_RLSINT ); //LPC43xx User manual page 1118
   NVIC_SetPriority(USART2_IRQn, 6);

   // Enable Interrupt for UART channel
   //NVIC_EnableIRQ(USART2_IRQn);
   //NVIC_EnaIRQ(USART2_IRQn);
}

void adc_init(void) {
	static ADC_CLOCK_SETUP_T ADCSetup;
	Chip_ADC_Init(ADC_ID, &ADCSetup);
	Chip_ADC_SetSampleRate(ADC_ID, &ADCSetup, SAMPLING_RATE);
    Chip_ADC_EnableChannel(ADC_ID, ADC_CHANNEL, ENABLE);
	Chip_ADC_SetResolution(ADC_ID, &ADCSetup, ADC_10BITS);
}

/* Polling routine for ADC example */
static int App_Polling_Test(uint16_t bufferADC[320]){
	uint16_t dataADC;
	Chip_ADC_SetBurstCmd(ADC_ID, DISABLE);

	while (1) {
		Chip_ADC_SetStartMode(ADC_ID, ADC_START_NOW, ADC_TRIGGERMODE_RISING);
		while (Chip_ADC_ReadStatus(ADC_ID, ADC_CHANNEL, ADC_DR_DONE_STAT) != SET) {} /* Waiting for A/D conversion complete */
		Chip_ADC_ReadValue(ADC_ID, ADC_CHANNEL, &dataADC); /* Read ADC value */
		return dataADC;
	}
}


/* -------------------------------------------------------------------
 * Declaración de main ADC/FIR
 * ------------------------------------------------------------------- */
uint32_t i;
arm_fir_instance_f32 S;
float32_t  *inputF32, *outputF32;



static void vSignalTask(void *pvParameters){


	while (1) {

	unsigned char Mensaje[] = "Datos adquiridos por el ADC: \r\n";
	float32_t testInput_f32_1kHz_8kHz[TEST_LENGTH_SAMPLES];
	uint16_t bufferADC[TEST_LENGTH_SAMPLES];
	uint16_t data[TEST_LENGTH_SAMPLES];
	int muestra=0;
	unsigned char valores[20];

	int contador1=0;
	int contador2=0;


	//SystemCoreClockUpdate();

	Chip_UART_SendBlocking (LPC_USART2 , Mensaje, strlen(Mensaje)); //printf(Mensaje)

	while(contador1 < 320){
		muestra = (int) App_Polling_Test(bufferADC[320]);
		testInput_f32_1kHz_8kHz[contador1]=muestra*3.3/1024; //valores entre 0 y 3.3V
		//data[contador1] = muestra; //array usado para representacion de las muestras capturadas
		contador1++;
	}

	while(contador2 < 320){
		uint8_t num = sprintf(valores, "%.10f,", testInput_f32_1kHz_8kHz[contador2]);
		Chip_UART_SendBlocking (LPC_USART2 , valores, num);
		contador2++;
	}

	//portTICK_RATE_MS
	xQueueSend(Queue_Datos,&testInput_f32_1kHz_8kHz,portTICK_RATE_MS);

	vTaskDelay(7000 / portTICK_RATE_MS);
	}//while(1)
}





static void vFilterTask(){

	unsigned char Mensaje2[] = "\r\n\r\nSeñal filtrada: \r\n";
	unsigned char Fin[] = "\r\nFin de conversion \r\n\r\n";
	int contador3=0;
	unsigned char filtro[20];
	float32_t testInput_f32_1kHz_8kHz[TEST_LENGTH_SAMPLES];

	while(1){
		xQueueReceive(Queue_Datos,&testInput_f32_1kHz_8kHz,10000*portTICK_RATE_MS);
	/* Iniciamos punteros a buffer de entrada y salida: */
		//float32_t entrada[320]={0,0.896802246667421,-0.363271264002681,1.76007351067010,0.363271264002681,1.00000000000000,1.53884176858763,-0.142039521920206,1.53884176858763,-0.278768257917525,-8.57252759403147e-16,0.278768257917527,-1.53884176858763,0.142039521920206,-1.53884176858763,-1.00000000000000,-0.363271264002679,-1.76007351067010,0.363271264002680,-0.896802246667419,-2.20436423846524e-15,0.896802246667417,-0.363271264002681,1.76007351067010,0.363271264002682,0.999999999999998,1.53884176858763,-0.142039521920207,1.53884176858763,-0.278768257917523,-2.57175827820944e-15,0.278768257917529,-1.53884176858763,0.142039521920205,-1.53884176858762,-1.00000000000000,-0.363271264002678,-1.76007351067010,0.363271264002679,-0.896802246667418,-4.40872847693047e-15,0.896802246667423,-0.363271264002676,1.76007351067010,0.363271264002684,0.999999999999996,1.53884176858764,-0.142039521920207,1.53884176858763,-0.278768257917508,-4.28626379701574e-15,0.278768257917517,-1.53884176858763,0.142039521920202,-1.53884176858762,-0.999999999999991,-0.363271264002676,-1.76007351067011,0.363271264002678,-0.896802246667407,-6.61309271539571e-15,0.896802246667415,-0.363271264002683,1.76007351067009,0.363271264002685,1.00000000000001,1.53884176858763,-0.142039521920211,1.53884176858763,-0.278768257917533,-6.00076931582203e-15,0.278768257917545,-1.53884176858763,0.142039521920201,-1.53884176858762,-0.999999999999993,-0.363271264002675,-1.76007351067011,0.363271264002677,-0.896802246667425,-8.81745695386094e-15,0.896802246667436,-0.363271264002684,1.76007351067009,0.363271264002665,1.00000000000001,1.53884176858763,-0.142039521920205,1.53884176858762,-0.278768257917504,-7.71527483462833e-15,0.278768257917547,-1.53884176858763,0.142039521920207,-1.53884176858762,-1.00000000000002,-0.363271264002673,-1.76007351067011,0.363271264002665,-0.896802246667424,-1.10218211923262e-14,0.896802246667418,-0.363271264002673,1.76007351067009,0.363271264002688,1.00000000000000,1.53884176858766,-0.142039521920212,1.53884176858762,-0.278768257917476,1.54392153981689e-14,0.278768257917549,-1.53884176858763,0.142039521920207,-1.53884176858759,-1.00000000000003,-0.363271264002672,-1.76007351067010,0.363271264002664,-0.896802246667403,-1.32261854307914e-14,0.896802246667419,-0.363271264002674,1.76007351067009,0.363271264002690,1.00000000000000,1.53884176858766,-0.142039521920213,1.53884176858762,-0.278768257917474,1.37247098793626e-14,0.278768257917551,-1.53884176858763,0.142039521920207,-1.53884176858759,-1.00000000000003,-0.363271264002670,-1.76007351067010,0.363271264002687,-0.896802246667401,-1.54305496692567e-14,0.896802246667420,-0.363271264002698,1.76007351067009,0.363271264002691,1,1.53884176858766,-0.142039521920213,1.53884176858762,-0.278768257917473,1.20102043605563e-14,0.278768257917553,-1.53884176858763,0.142039521920206,-1.53884176858759,-1.00000000000003,-0.363271264002669,-1.76007351067010,0.363271264002686,-0.896802246667400,-1.45532606344540e-13,0.896802246667500,-0.363271264002745,1.76007351067005,0.363271264002737,0.999999999999884,1.53884176858771,-0.142039521920213,1.53884176858760,-0.278768257917471,-8.91802841646640e-14,0.278768257917607,-1.53884176858765,0.142039521920165,-1.53884176858754,-1.00000000000020,-0.363271264002580,-1.76007351067015,0.363271264002615,-0.896802246667359,-2.11685816801414e-13,0.896802246667501,-0.363271264002723,1.76007351067005,0.363271264002738,0.999999999999826,1.53884176858771,-0.142039521920227,1.53884176858760,-0.278768257917416,-1.40632781186677e-13,0.278768257917609,-1.53884176858767,0.142039521920178,-1.53884176858754,-1.00000000000015,-0.363271264002622,-1.76007351067017,0.363271264002638,-0.896802246667358,-1.49941334821470e-13,0.896802246667464,-0.363271264002747,1.76007351067007,0.363271264002740,0.999999999999937,1.53884176858776,-0.142039521920241,1.53884176858760,-0.278768257917309,-9.26092952022766e-14,0.278768257917611,-1.53884176858767,0.142039521920191,-1.53884176858749,-1.00000000000015,-0.363271264002577,-1.76007351067015,0.363271264002637,-0.896802246667278,-8.81968528415266e-14,0.896802246667465,-0.363271264002748,1.76007351067004,0.363271264002785,0.999999999999878,1.53884176858781,-0.142039521920228,1.53884176858761,-0.278768257917360,-4.45858092178759e-14,0.278768257917665,-1.53884176858766,0.142039521920177,-1.53884176858754,-1.00000000000009,-0.363271264002531,-1.76007351067013,0.363271264002659,-0.896802246667316,-1.54350063298401e-13,0.896802246667506,-0.363271264002725,1.76007351067006,0.363271264002743,0.999999999999820,1.53884176858777,-0.142039521920242,1.53884176858760,-0.278768257917411,-9.60383062398892e-14,0.278768257917614,-1.53884176858767,0.142039521920163,-1.53884176858758,-1.00000000000015,-0.363271264002574,-1.76007351067015,0.363271264002635,-0.896802246667354,-9.26055813184571e-14,0.896802246667468,-0.363271264002749,1.76007351067004,0.363271264002788,0.999999999999875,1.53884176858772,-0.142039521920229,1.53884176858761,-0.278768257917356,-1.47490803261903e-13,0.278768257917564,-1.53884176858766,0.142039521920176,-1.53884176858753,-1.00000000000010,-0.363271264002616,-1.76007351067017,0.363271264002611,-0.896802246667314,-1.58758791775331e-13,0.896802246667508,-0.363271264002773,1.76007351067006,0.363271264002746,0.999999999999816,1.53884176858777,-0.142039521920243,1.53884176858760,-0.278768257917407,-9.94673172775018e-14,0.278768257917618,-1.53884176858767,0.142039521920163,-1.53884176858758,-1.00000000000016,-0.363271264002571,-1.76007351067015,0.363271264002634,-0.896802246667273,-9.70143097953875e-14,0.896802246667470,-0.363271264002751,1.76007351067004,0.363271264002791,0.999999999999871,1.53884176858772,-0.142039521920230,1.53884176858761,-0.278768257917353,-1.50919814299515e-13,0.278768257917567,-1.53884176858766,0.142039521920149,-1.53884176858753,-1.00000000000010,-0.363271264002525,-1.76007351067013,0.363271264002609,-0.896802246667311};
		inputF32 = &testInput_f32_1kHz_8kHz[0];
		outputF32 = &testOutput[0];

		/* Llamamos a la funcion FIR_init para inicializar una instancia de la estructura: */
		arm_fir_init_f32(&S, NUM_TAPS, (float32_t *)&firCoeffs32[0], &firStateF32[0], blockSize);

		/* ----------------------------------------------------------------------
		** Llamada la funcion del proceso FIR para cada muestra blockSize
		** ------------------------------------------------------------------- */
		for(i=0; i < numBlocks; i++)
			arm_fir_f32(&S, inputF32 + (i * blockSize), outputF32 + (i * blockSize), blockSize);

		Chip_UART_SendBlocking (LPC_USART2 , Mensaje2, strlen(Mensaje2)); //printf(Mensaje2)

		while(contador3 < 320){
			uint8_t num2 = sprintf(filtro, "%.10f,", outputF32[contador3]);
			Chip_UART_SendBlocking (LPC_USART2 , filtro, num2);
			contador3++;
		}


		Chip_UART_SendBlocking (LPC_USART2 , Fin, strlen(Fin)); //printf("Fin de conversion");


	}
}





int32_t main(void){

	prvSetupHardware();

	Queue_Datos = xQueueCreate(320 , sizeof(float));

	xTaskCreate(vSignalTask, "vSignalTask", 10*configMINIMAL_STACK_SIZE, NULL,
				(tskIDLE_PRIORITY + 1UL), (TaskHandle_t *) NULL);

	xTaskCreate(vFilterTask, "vFilterTask", 10*configMINIMAL_STACK_SIZE, NULL,
					(tskIDLE_PRIORITY + 1UL), (TaskHandle_t *) NULL);

		vTaskStartScheduler();

	return 0;
}

